# SDD 2.4 - Telegram cache persistence

## 1.0 Idea

Add minimal persistence for chat metadata and message cache to reduce network
round trips. Keep caches small, bounded, and pluggable while exposing fast reads
for the UI and LLM workflows.

## 2.0 Structured spec

### 2.1 Scope

- [x] (2.1.1) Persist chat metadata (chat_id, title, peer kind, last_message_id,
  last_message_at, unread_count when available).
- [x] (2.1.2) Persist recent messages per chat (message_id, author_id, timestamp,
  edit_timestamp, text, outgoing flag).
- [x] (2.1.3) Load persisted cache into memory during bootstrap.
- [x] (2.1.4) Write cache updates through a background flush with debounce.
- [x] (2.1.5) Enforce size limits (max chats, max messages per chat, max bytes).
- [x] (2.1.6) Expose read APIs for chat list and message history to reduce
  network calls.
- [x] (2.1.7) Provide a pluggable store trait with a default local file store.

### 2.2 Out of scope

- [ ] (2.2.1) Full history backfill or server sync beyond the cache window.
- [ ] (2.2.2) Media, attachments, or rich message formatting.
- [ ] (2.2.3) Cross-device merge or conflict resolution.
- [ ] (2.2.4) Encryption at rest beyond OS defaults.

### 2.3 Domain model

- [x] (2.3.1) `ChatSummary` with id, title, peer kind, last message metadata,
  unread count.
- [x] (2.3.2) `CachedMessage` with chat_id, message_id, author_id, timestamp,
  edit timestamp, text, outgoing.
- [x] (2.3.3) `ChatCache` map keyed by `ChatId` with ordered messages.
- [x] (2.3.4) `CacheLimits` for max chats, max messages per chat, max bytes.
- [x] (2.3.5) `CacheStore` trait with load, save, upsert chat, upsert message,
  delete message, clear.

### 2.4 Cache update rules

- [x] (2.4.1) `MessageNew` inserts message and updates chat last message fields.
- [x] (2.4.2) `MessageEdited` updates cached message text and edit timestamp.
- [x] (2.4.3) `ReadReceipt` updates unread count or last read message when
  available.
- [x] (2.4.4) Evict oldest messages per chat when per-chat limits are exceeded.
- [x] (2.4.5) Evict least recently updated chats when chat limit is exceeded.
- [x] (2.4.6) Cache writes are debounced and never block the UI loop.

### 2.5 Persistence format and location

- [x] (2.5.1) Persist cache under the project-local data directory in dev.
- [x] (2.5.2) Default store uses a sqlite database file (schema defined).
- [x] (2.5.3) Store interface allows alternate backends later without changing
  callers.

### 2.6 Configuration

- [x] (2.6.1) Add cache config under `[telegram.cache]` in app config.
- [x] (2.6.2) Defaults include limits (max messages per chat: 5000; max chats:
  TBD; max cache bytes: TBD) and a flush debounce duration. These initial values
  are subject to change as usage data is collected.

### 2.7 Logging

- [x] (2.7.1) Log cache load, save, eviction counts, and store errors.
- [x] (2.7.2) Respect log content settings before logging message text.

## 3.0 Implementation plan

- [x] (3.1.1) Add `core/src/telegram/cache.rs` with cache types and manager.
- [x] (3.1.2) Define `CacheStore` trait and implement a `FileCacheStore`.
- [x] (3.1.3) Wire cache updates from domain events into the cache manager.
- [x] (3.1.4) Expose cache read APIs from `core/src/telegram/mod.rs`.
- [x] (3.1.5) Add cache config wiring in `app/src/config.rs` and
  `app/config/app.toml`.
- [x] (3.1.6) Add logging around cache load, flush, and eviction events.

## 4.0 Test plan (generation)

- [x] (4.1.1) Cache loads from disk and exposes chat summaries.
- [x] (4.1.2) Message edits update cached text and edit timestamps.
- [x] (4.1.3) Eviction removes oldest messages and least recently updated chats.
- [x] (4.1.4) Persisted snapshot round-trips with limits enforced.
- [x] (4.1.5) Debounced writes coalesce multiple updates into one flush.

## 5.0 Code plan (follow-up after tests)

- [x] (5.1.1) Implement cache manager and store plumbing.
- [x] (5.1.2) Implement file store with atomic save and load.
- [x] (5.1.3) Add unit tests for cache behavior and persistence.
- [x] (5.1.4) Run `cargo test`, `cargo fmt`, and `cargo clippy -D warnings`.
