# SDD 2.3 - Telegram send pipeline

## 1.0 Idea

Provide a resilient send pipeline for Telegram messages that supports text,
reply, edit, and delete operations with retry and backoff handling, while
queueing unsent work when the client is offline.

## 2.0 Structured spec

### 2.1 Scope

- [x] (2.1.1) Support send text messages to a peer, with optional reply-to.
- [x] (2.1.2) Support editing an existing message by ID.
- [x] (2.1.3) Support deleting a message by ID.
- [x] (2.1.4) Queue unsent requests when transient or offline errors occur.
- [x] (2.1.5) Apply rate-limit waits or exponential backoff before retrying.
- [x] (2.1.6) Expose status updates for queued, sending, sent, and failed.

### 2.2 Out of scope

- [ ] (2.2.1) Media uploads, albums, or rich message formatting.
- [ ] (2.2.2) Persistent queue storage across restarts.
- [ ] (2.2.3) Chat discovery or peer resolution from bare IDs.

### 2.3 Domain model

- [x] (2.3.1) `SendId` identifies a queued or in-flight request.
- [x] (2.3.2) `SendRequest` variants:
  - [x] (2.3.2.1) `SendText` with `peer`, `text`, `reply_to`.
  - [x] (2.3.2.2) `EditText` with `peer`, `message_id`, `text`.
  - [x] (2.3.2.3) `DeleteMessage` with `peer`, `message_id`.
- [x] (2.3.3) `SendResult` variants for sent, edited, and deleted outcomes.
- [x] (2.3.4) `SendStatus` variants for `Queued`, `Sending`, `Sent`, `Failed`.

### 2.4 Retry and backoff rules

- [x] (2.4.1) Retry on transient `InvocationError` cases (I/O, transport,
  dropped, deserialization, invalid DC).
- [x] (2.4.2) Treat `FLOOD_WAIT` and `SLOWMODE_WAIT` as rate-limit delays using
  the server-provided wait seconds.
- [x] (2.4.3) Apply exponential backoff capped by a configured max delay for
  other retryable errors.
- [x] (2.4.4) Respect a configurable max retry attempt limit (or unlimited).

### 2.5 Queue behavior

- [x] (2.5.1) Queue is bounded by a configurable capacity.
- [x] (2.5.2) If queue capacity is exceeded, new requests are rejected.
- [x] (2.5.3) Queue items are retried in order of next-attempt time.
- [x] (2.5.4) Status updates are emitted on enqueue, retry, success, and failure.

### 2.6 Configuration

- [x] (2.6.1) `SendPipelineConfig` includes queue limit and retry controls.
- [x] (2.6.2) Defaults are defined in core and wired to app config.

### 2.7 Logging

- [x] (2.7.1) Log send attempts and retries with request ID and attempt count.
- [x] (2.7.2) Log final failures with error details.

## 3.0 Implementation plan

- [x] (3.1.1) Add `core/src/telegram/send.rs` with pipeline types and worker.
- [x] (3.1.2) Implement a `SendTransport` trait with a grammers adapter.
- [x] (3.1.3) Integrate send pipeline config into `TelegramConfig` and
  `TelegramBootstrap`.
- [x] (3.1.4) Wire app config fields for send pipeline settings.
- [x] (3.1.5) Export send pipeline types from `core/src/telegram/mod.rs`.

## 4.0 Test plan (generation)

- [x] (4.1.1) Retries on rate-limit errors and eventually succeeds.
- [x] (4.1.2) Fails after max retry attempts when configured.
- [x] (4.1.3) Rejects enqueue when the queue capacity is full.
- [x] (4.1.4) Surfaces invalid message IDs as non-retryable failures.

## 5.0 Code plan (follow-up after tests)

- [x] (5.1.1) Implement send pipeline worker and status tracking.
- [x] (5.1.2) Implement backoff and rate-limit handling.
- [x] (5.1.3) Add unit tests and run `cargo test` for core.
- [x] (5.1.4) Run `cargo fmt` and `cargo clippy -D warnings`.
