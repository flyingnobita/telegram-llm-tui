# SDD 2.2 - Telegram domain events and UI streams

## 1.0 Idea

Provide a stable, UI-friendly stream of Telegram domain events by mapping
`grammers` updates into a small set of domain event types with predictable IDs,
timestamps, and buffering behavior.

## 2.0 Structured spec

### 2.1 Scope

- [ ] (2.1.1) Model four domain events: new message, edited message, read
  receipt, typing.
- [ ] (2.1.2) Use server-provided identifiers for chat, message, and user IDs.
- [ ] (2.1.3) Use server-provided timestamps for event time.
- [ ] (2.1.4) Expose a UI-facing event stream with a bounded buffer and
  drop-oldest behavior.
- [ ] (2.1.5) Log mapping errors, dropped events, and lagged subscribers.

### 2.2 Out of scope

- [ ] (2.2.1) Channel and group-specific semantics for read receipts and
  typing events (defer as per PLANS 2.2.2.11).
- [ ] (2.2.2) Rich media parsing or service message handling beyond basic
  message metadata.
- [ ] (2.2.3) Persistence of domain events.

### 2.3 Domain model

- [ ] (2.3.1) `ChatId`, `MessageId`, and `UserId` are lightweight newtypes over
  `i64`, derived from server IDs.
- [ ] (2.3.2) `DomainEvent` enum with variants:
  - [ ] (2.3.2.1) `MessageNew` with: `chat_id`, `message_id`, `author_id`,
    `timestamp`, `text`.
  - [ ] (2.3.2.2) `MessageEdited` with: `chat_id`, `message_id`, `editor_id`,
    `timestamp`, `text`.
- [ ] (2.3.2.3) `ReadReceipt` with: `chat_id`, `reader_id`, `timestamp`,
  `last_read_message_id`.
  - [ ] (2.3.2.4) `Typing` with: `chat_id`, `user_id`, `timestamp`.
- [ ] (2.3.3) `timestamp` is stored as Unix epoch seconds (`i64`), copied from
  Telegram update data without local time conversion.

### 2.4 Mapping rules

- [ ] (2.4.1) `EventMapper` converts `grammers_client::Update` to
  `Option<DomainEvent>`.
- [ ] (2.4.2) If an update lacks required IDs or timestamps, mapping returns
  `None` and records a mapping error log entry.
- [ ] (2.4.3) Unsupported updates return `None` and increment a dropped or
  unsupported counter log entry.
- [ ] (2.4.4) Read receipts map only from `ReadHistoryOutbox` when the peer is
  a user (direct chat); channel and group receipts are deferred.
- [ ] (2.4.5) Typing events map only from `UpdateUserTyping` (direct chat);
  group and channel typing updates are deferred.
- [ ] (2.4.6) Typing and read receipt timestamps use update state `date` when
  the update does not include its own timestamp.

### 2.5 Stream behavior

- [ ] (2.5.1) Event pump reads from the update pump and forwards mapped events
  into a bounded buffer (default size 1024).
- [ ] (2.5.2) When the buffer is full, drop the oldest event and log the
  drop.
- [ ] (2.5.3) UI consumers use a `broadcast` channel with lag handling; lagged
  subscribers receive a warning log entry.

### 2.6 Configuration

- [ ] (2.6.1) `TelegramConfig` includes event buffer size and drop policy.
- [ ] (2.6.2) Defaults: drop-oldest, buffer size 1024.

### 2.7 Logging

- [ ] (2.7.1) Log mapping errors at `warn` with update context.
- [ ] (2.7.2) Log dropped events at `warn` with buffer size and event type.
- [ ] (2.7.3) Log lagged subscriber events at `warn` with lag count.

## 3.0 Implementation plan

- [ ] (3.1.1) Add `core/src/telegram/events.rs` with `DomainEvent` and payloads.
- [ ] (3.1.2) Add ID newtypes in `core/src/telegram/ids.rs` or `events.rs`.
- [ ] (3.1.3) Implement `EventMapper` for the four update types.
- [ ] (3.1.4) Add `spawn_domain_event_pump` to bridge update pump to event
  stream with drop-oldest policy.
- [ ] (3.1.5) Expose `EventStream` API from `core/src/telegram/mod.rs`.
- [ ] (3.1.6) Extend `TelegramConfig` for event buffer config defaults.
- [ ] (3.1.7) Add structured logging for mapping errors, drops, and lag.

## 4.0 Test plan (generation)

- [ ] (4.1.1) Unit tests for mapping: new message, edited message, read receipt,
  typing.
- [ ] (4.1.2) Unit test for drop-oldest behavior when the event buffer is full.
- [ ] (4.1.3) Unit test for lagged broadcast subscribers (simulate receiver
  falling behind).
- [ ] (4.1.4) Unit test for unsupported updates returning `None`.

## 5.0 Code plan (follow-up after tests)

- [ ] (5.1.1) Implement data types and mapper scaffolding.
- [ ] (5.1.2) Wire event pump and stream API.
- [ ] (5.1.3) Add config defaults and logging wiring.
- [ ] (5.1.4) Run `cargo fmt`, `cargo clippy -D warnings`, and unit tests.
