# SDD 3.1.5 - UI cache wiring

## 1.0 Idea

Map cached Telegram chat and message data into UI state so the TUI layout can
render real data instead of placeholders.

## 2.0 Structured spec

### 2.1 Scope

- [x] (2.1.1) Map cached chat summaries into UI chat list items.
- [x] (2.1.2) Map cached messages for the selected chat into UI messages.
- [x] (2.1.3) Choose a selected chat when none is provided.
- [x] (2.1.4) Preserve composer and overlay state when refreshing.
- [x] (2.1.5) Provide deterministic timestamp formatting for UI messages.

### 2.2 Out of scope

- [ ] (2.2.1) Real-time UI rendering loop or event handling.
- [ ] (2.2.2) User name resolution or avatar rendering.
- [ ] (2.2.3) Scrollback, paging, or message selection.

### 2.3 Mapping rules

- [x] (2.3.1) Chat list is sorted by `last_message_at` descending, then title.
- [x] (2.3.2) If no selected chat is provided or it no longer exists, select
  the first chat after sorting.
- [x] (2.3.3) Chat list item title falls back to `Chat {id}` when missing.
- [x] (2.3.4) Unread count defaults to zero when not available.
- [x] (2.3.5) Message author label is `You` for outgoing messages and
  `User {id}` otherwise.
- [x] (2.3.6) Message timestamps render as `HH:MM` in UTC; invalid timestamps
  fall back to the raw epoch value.
- [x] (2.3.7) Message list is sorted by timestamp ascending.

### 2.4 State integration

- [x] (2.4.1) Introduce a cache-to-UI bridge that holds UI state and selected
  chat state.
- [x] (2.4.2) Refreshing UI state updates chat and message lists without
  overwriting input or overlay state.

## 3.0 Implementation plan

- [x] (3.1.1) Add `app/src/ui_state.rs` with cache-to-UI mapping helpers.
- [x] (3.1.2) Add a `UiCacheBridge` struct to hold selection and UI state.
- [x] (3.1.3) Wire the bridge into the app loop after cache updates.
- [x] (3.1.4) Add unit tests for selection, sorting, and message mapping.
- [x] (3.1.5) Run formatting, linting, and tests.

## 4.0 Test plan (generation)

- [x] (4.1.1) Test that the most recent chat is selected when none is set.
- [x] (4.1.2) Test that messages map with correct author labels and order.
- [x] (4.1.3) Test that message timestamps format as `HH:MM` for valid epochs.

## 5.0 Code plan (follow-up after tests)

- [x] (5.1.1) Implement the mapping helpers and bridge.
- [x] (5.1.2) Integrate the bridge into `app/src/main.rs`.
- [x] (5.1.3) Ensure tests and linting pass.
