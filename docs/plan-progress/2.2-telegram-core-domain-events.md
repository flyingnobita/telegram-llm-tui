# PLANS 2.2 - Telegram domain events and UI streams

## 2.2.1 Feature scope

1. [x] (2.2.1.1) Model domain events for new message, edited message,
   read receipt, typing.
2. [x] (2.2.1.2) Convert grammers updates into domain events with stable IDs
   and timestamps.
3. [x] (2.2.1.3) Expose domain events as streams for the UI layer.
4. [x] (2.2.1.4) Define buffering and drop behavior for event streams:
   drop oldest (keep latest); default buffer size 1024 events.
5. [x] (2.2.1.5) Unit tests for mapping and stream behavior.

## 2.2.2 Implementation notes

1. [x] (2.2.2.1) Add `core/src/telegram/events.rs` with a `DomainEvent` enum
   and payload structs for message, edit, read receipt, and typing events.
2. [x] (2.2.2.2) Add lightweight ID types (`ChatId`, `MessageId`, `UserId`)
   to decouple UI from grammers types.
3. [x] (2.2.2.3) Implement an `EventMapper` that converts
   `grammers_client::Update` into `Option<DomainEvent>` and records dropped or
   unsupported updates.
4. [x] (2.2.2.4) Add `spawn_domain_event_pump` to read from the update pump
   and forward mapped events into a bounded channel (drop oldest when full).
5. [x] (2.2.2.5) Decide on fan-out strategy for UI consumers: use
   `broadcast` with lag handling.
6. [x] (2.2.2.6) Expose `EventStream` API from `core/src/telegram/mod.rs`
   with start and stop hooks.
7. [x] (2.2.2.7) Add logging for dropped events, mapping errors, and lagged
   subscribers.
8. [x] (2.2.2.8) Extend `TelegramConfig` to include event buffer sizes and
   drop policy (drop oldest, default size 1024 events).
9. [x] (2.2.2.9) Use server-provided IDs for `ChatId`, `MessageId`, and
   `UserId`.
10. [x] (2.2.2.10) Use server-provided timestamps for event time.
11. [x] (2.2.2.11) Defer channel and group semantics for read receipts and
   typing events.

## 2.2.3 Current state checklist

1. [x] (2.2.3.1) `core/src/telegram/updates.rs` provides an update pump and
   `UpdateEvent`.
2. [x] (2.2.3.2) Domain event types defined in `core/src/telegram/events.rs`.
3. [x] (2.2.3.3) Update to domain event mapping implemented.
4. [x] (2.2.3.4) Event stream API exposed for UI consumers.
5. [x] (2.2.3.5) App or UI wiring for domain events.

## 2.2.4 Next steps

1. [x] (2.2.4.1) Sketch the `DomainEvent` schema and ID types, then update
   the core module exports.
2. [x] (2.2.4.2) Implement the mapper for the first four event types and add
   unit tests for each mapping path.
3. [x] (2.2.4.3) Add the domain event pump that bridges `UpdatePump` into the
   UI stream.
4. [x] (2.2.4.4) Decide on backpressure behavior and document it in the
   config defaults (drop oldest; default buffer size 1024 events).

## 2.2.5 Follow-ups and gaps

1. [ ] (2.2.5.1) Confirm how read receipts should be represented for channels
   and groups.
2. [ ] (2.2.5.2) Decide how to treat service messages and media-only updates.
3. [ ] (2.2.5.3) Verify typing events across one-to-one and group chats.
4. [ ] (2.2.5.4) Add integration tests with mocked grammers updates.

## 2.2.6 Logging

1. (2.2.6.1) Primary log file is `data/logs/app.log` (configured in
   `app/config/app.toml`).
2. (2.2.6.2) Error log file is `data/logs/app-error.log` (configured in
   `app/config/app.toml`).
3. (2.2.6.3) Log level uses `[logging].level` in `app/config/app.toml`
   (default `info`).
4. (2.2.6.4) Log format uses `[logging].format` in `app/config/app.toml`
   (default `plain`).
5. (2.2.6.5) Rotation uses `[logging].rotation` and size-based defaults in
   `app/config/app.toml`.
